<!doctype html>
<meta charset="utf-8">
<title>Pocket Server — Home</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;max-width:820px;margin:32px auto;padding:0 16px}
  h1{margin:0 0 12px}
  .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:16px 0}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  label{display:inline-flex;gap:6px;align-items:center}
  input[type=number]{width:120px;padding:6px 8px;border:1px solid #bbb;border-radius:8px}
  button{padding:8px 12px;border:1px solid #888;background:#f5f5f5;border-radius:10px;cursor:pointer}
  button.ok{background:#e8ffe8;border-color:#6a6}
  .muted{color:#666}
  .pill{display:inline-block;padding:2px 8px;border:1px solid #ccc;border-radius:999px;background:#fafafa}
  a{color:#06c;text-decoration:none} a:hover{text-decoration:underline}
</style>

<h1>Pocket Server</h1>

<nav style="margin:8px 0 16px; display:flex; gap:12px; flex-wrap:wrap">
  <a href="/">Home</a>
  <a href="/ui/overview">Overview</a>
  <a href="/ui/deep">Deep</a>
  <a href="/apps/welcome" target="_blank">Apps</a>
  <span id="ssid" class="muted" style="margin-left:auto"></span>
</nav>
<div class="card">
<div class="card">
  <h3>Hosting</h3>
  <div id="svcState" class="row"><span class="pill">Loading…</span></div>
  <div class="row">
    <button id="stopServing"  class="btn">Stop Serving (LAN)</button>
    <button id="startServing" class="btn ok">Start Serving (LAN)</button>
    <button id="shutdownBtn"  class="btn warn">Shut Down Pocket Server</button>
    <button id="startBtn"     class="btn ok">Start Pocket Server</button>
    <button id="refreshBtn"   class="btn">Refresh</button>
  </div>
</div>
  <h3>Apps</h3>
  <div class="row" style="justify-content:space-between;width:100%">
    <div>
      <strong>Welcome</strong> — <a href="/apps/welcome" target="_blank">open</a> <span id="welcomeDirectLink" class="muted"></span><br>
      <div style="margin-top:8px">
        <label>Enabled <input type="checkbox" id="welcomeEnabled"></label>
        <label>Port <input type="number" id="welcomePort" min="1024" max="65535" step="1"></label>
        <button id="saveWelcome" class="btn ok">Save & Restart</button>
        <span id="state" class="pill">Loading…</span>
      </div>
        <label>Enabled <input type="checkbox" id="welcomeEnabled"></label>
        <label>Port <input type="number" id="welcomePort" min="1024" max="65535" step="1"></label>
        <button id="saveWelcome" class="btn ok">Save & Restart</button>
        <span id="state" class="pill">Loading…</span>
      </div>
        <label>Enabled <input type="checkbox" id="welcomeEnabled"></label>
        <label>Port <input type="number" id="welcomePort" min="1024" max="65535" step="1"></label>
        <button id="saveWelcome" class="btn ok">Save & Restart</button>
        <span id="state" class="pill">Loading…</span>
      </div>
      <span id="linkDirectWrap" class="muted"></span>
      <div style="margin-top:8px">
        <label>Enabled <input type="checkbox" id="welcomeEnabled"></label>
        <label>Port <input type="number" id="welcomePort" min="1024" max="65535" step="1"></label>
        <button id="saveWelcome" class="ok">Save & Restart</button>
        <span id="state" class="pill">Loading…</span>
      </div>
    </div>
  </div>
  <small class="muted">“Save & Restart” updates the registry, restarts the app on the new port, and reloads routing.</small>
</div>

<script>
const $ = s => document.querySelector(s);
const api = (p, opt={}) => fetch(p, { ...opt, headers:{'Content-Type':'application/json'} });
const host = location.hostname || '127.0.0.1';

function setDirectLink(port){
  const wrap = $('#linkDirectWrap');
  if(!wrap) return;
  wrap.innerHTML = ` · <a href="http://${host}:${port}/" target="_blank">direct: ${port}</a>`;
}

async function loadWelcome(){
  try{
    const r = await api('/admin/app/welcome/meta');
    if(!r.ok) throw new Error(await r.text());
    const m = await r.json();
    $('#welcomeEnabled').checked = !!m.enabled;
    $('#welcomePort').value = m.port;
    setDirectLink(m.port);
    $('#state').textContent = 'Ready';
  }catch(e){
    console.error(e);
    $('#state').textContent = 'Meta error';
  }
}

async function saveWelcome(){
  const btn = $('#saveWelcome'); btn.disabled = true; $('#state').textContent = 'Updating…';
  const port = parseInt($('#welcomePort').value||'0',10);
  const enabled = $('#welcomeEnabled').checked;
  if(!(port>=1024 && port<=65535)){ alert('Invalid port (1024–65535)'); btn.disabled=false; $('#state').textContent='Error'; return; }
  try{
    // 1) Set port via ADMIN API (not the app server)
    let r = await api('/admin/app/welcome/port', { method:'POST', body: JSON.stringify({port}) });
    if(!r.ok) throw new Error(await r.text());

    // 2) Ensure enabled/disabled via ADMIN API
    r = await api('/admin/app/welcome/toggle?enabled='+(enabled?'true':'false'), { method:'POST' });
    if(!r.ok) throw new Error(await r.text());

    // 3) Refresh link + state
    setDirectLink(port);
    $('#state').textContent = 'Moved to '+port;
  }catch(e){
    console.error(e);
    alert('Save failed: '+e.message);
    $('#state').textContent = 'Error';
  }finally{
    btn.disabled = false;
  }
}

document.getElementById('saveWelcome').addEventListener('click', saveWelcome);
loadWelcome();
</script>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const api = (p, opt={}) => fetch(p, { ...opt, headers:{ "Content-Type":"application/json" } });
  const host = location.hostname || "127.0.0.1";
  function setDirectLink(port){
    const span = $("#welcomeDirectLink");
    if(span){ span.innerHTML = " · <a href=\\"http://"+host+":"+port+"/\\" target=\\"_blank\\">direct: "+port+"</a>"; }
  }
  async function loadWelcome(){
    try{
      const r = await api("/admin/app/welcome/meta");
      if(!r.ok) throw new Error(await r.text());
      const m = await r.json();
      const en = $("#welcomeEnabled"), po = $("#welcomePort");
      if(en) en.checked = !!m.enabled;
      if(po) po.value = m.port;
      setDirectLink(m.port);
      const st=$("#state"); if(st) st.textContent="Ready";
    }catch(e){ console.error(e); const st=$("#state"); if(st) st.textContent="Meta error"; }
  }
  async function saveWelcome(){
    const btn = $("#saveWelcome"); if(btn) {btn.disabled=true; btn.textContent="Saving…";}
    const st = $("#state"); if(st) st.textContent="Updating…";
    const port = parseInt(($("#welcomePort")||{}).value||"0",10);
    const enabled = ($("#welcomeEnabled")||{}).checked;
    if(!(port>=1024 && port<=65535)){
      alert("Invalid port (1024–65535)");
      if(btn){btn.disabled=false; btn.textContent="Save & Restart";}
      if(st) st.textContent="Error";
      return;
    }
    try{
      // Always talk to ADMIN API (not the app)
      let r = await api("/admin/app/welcome/port", { method:"POST", body: JSON.stringify({port}) });
      if(!r.ok) throw new Error(await r.text());
      r = await api("/admin/app/welcome/toggle?enabled="+(enabled?"true":"false"), { method:"POST" });
      if(!r.ok) throw new Error(await r.text());
      setDirectLink(port);
      if(st) st.textContent = "Moved to "+port;
    }catch(e){
      console.error(e); alert("Save failed: "+e.message);
      if(st) st.textContent = "Error";
    }finally{
      if(btn){btn.disabled=false; btn.textContent="Save & Restart";}
    }
  }
  window.addEventListener("DOMContentLoaded", function(){
    loadWelcome();
    const btn = document.getElementById("saveWelcome");
    if(btn && !btn._wired){ btn._wired=true; btn.addEventListener("click", saveWelcome); }
  });
})();
</script>


<script>
(function(){
  const $ = s => document.querySelector(s);
  const api = (p, opt={}) => fetch(p, { ...opt, headers:{ "Content-Type":"application/json" } });
  const host = location.hostname || "127.0.0.1";
  function setDirectLink(port){
    const span = $("#welcomeDirectLink");
    if(span){ span.innerHTML = " · <a href=\\"http://"+host+":"+port+"/\\" target=\\"_blank\\">direct: "+port+"</a>"; }
  }
  async function loadWelcome(){
    try{
      const r = await api("/admin/app/welcome/meta");
      if(!r.ok) throw new Error(await r.text());
      const m = await r.json();
      const en = $("#welcomeEnabled"), po = $("#welcomePort");
      if(en) en.checked = !!m.enabled;
      if(po) po.value = m.port;
      setDirectLink(m.port);
      const st=$("#state"); if(st) st.textContent="Ready";
    }catch(e){ console.error(e); const st=$("#state"); if(st) st.textContent="Meta error"; }
  }
  async function saveWelcome(){
    const btn = $("#saveWelcome"); if(btn) {btn.disabled=true; btn.textContent="Saving…";}
    const st = $("#state"); if(st) st.textContent="Updating…";
    const port = parseInt(($("#welcomePort")||{}).value||"0",10);
    const enabled = ($("#welcomeEnabled")||{}).checked;
    if(!(port>=1024 && port<=65535)){
      alert("Invalid port (1024–65535)");
      if(btn){btn.disabled=false; btn.textContent="Save & Restart";}
      if(st) st.textContent="Error";
      return;
    }
    try{
      // Always talk to ADMIN API (not the app)
      let r = await api("/admin/app/welcome/port", { method:"POST", body: JSON.stringify({port}) });
      if(!r.ok) throw new Error(await r.text());
      r = await api("/admin/app/welcome/toggle?enabled="+(enabled?"true":"false"), { method:"POST" });
      if(!r.ok) throw new Error(await r.text());
      setDirectLink(port);
      if(st) st.textContent = "Moved to "+port;
    }catch(e){
      console.error(e); alert("Save failed: "+e.message);
      if(st) st.textContent = "Error";
    }finally{
      if(btn){btn.disabled=false; btn.textContent="Save & Restart";}
    }
  }
  window.addEventListener("DOMContentLoaded", function(){
    loadWelcome();
    const btn = document.getElementById("saveWelcome");
    if(btn && !btn._wired){ btn._wired=true; btn.addEventListener("click", saveWelcome); }
  });
})();
</script>


<script>
(function(){
  const $ = s => document.querySelector(s);
  const api = (p, opt={}) => fetch(p, { ...opt, headers:{ "Content-Type":"application/json" } });
  const host = location.hostname || "127.0.0.1";

  // --- SSID + status
  async function loadSSID(){
    try{
      const s = await fetch("/stats").then(r=>r.json());
      const ssid = s?.network?.ssid || s?.wifi?.ssid || "";
      if(ssid) { const el=$("#ssid"); if(el) el.textContent = "SSID: "+ssid; }
    }catch{}
  }
  async function status(){
    try{
      const r = await api("/admin/status");
      if(!r.ok) throw 0;
      const s = await r.json();
      const el = $("#svcState");
      if(el){
        const serving = s?.serve_mode || "lan";
        const txt = "Mode: "+serving.toUpperCase() + (s?.lan_active===false ? " (local only)" : "");
        el.innerHTML = "<span class=\\"pill\\">"+txt+"</span>";
      }
    }catch(e){
      const el = $("#svcState"); if(el) el.innerHTML="<span class=\\"pill\\">Unknown</span>";
    }
  }

  // --- Hosting actions
  async function post(path){
    const r = await api(path,{method:"POST"});
    if(!r.ok){ const t = await r.text(); throw new Error(t); }
    return r.json().catch(()=>({ok:true}));
  }
  async function serveOff(){ await post("/admin/serve_off"); await status(); }
  async function serveOn(){  await post("/admin/serve_on");  await status(); }
  async function shutdown(){ await post("/admin/shutdown"); }
  async function startPS(){  await post("/admin/start"); await status(); }
  async function refresh(){  await status(); loadSSID(); }

  function wireHosting(){
    const byId = id => document.getElementById(id);
    const w = [
      ["stopServing", serveOff],
      ["startServing", serveOn],
      ["shutdownBtn", shutdown],
      ["startBtn", startPS],
      ["refreshBtn", refresh],
    ];
    for(const [id, fn] of w){
      const b = byId(id);
      if(b && !b._wired){ b._wired=true; b.addEventListener("click", async ()=>{
        const old = b.textContent; b.disabled=true; b.textContent="…";
        try{ await fn(); } catch(e){ alert("Action failed: "+e.message); }
        b.disabled=false; b.textContent=old;
      });}
    }
  }

  // --- Welcome app controls (unchanged from working version)
  function setDirectLink(port){
    const span = $("#welcomeDirectLink");
    if(span){ span.innerHTML = " · <a href=\\"http://"+host+":"+port+"/\\" target=\\"_blank\\">direct: "+port+"</a>"; }
  }
  async function loadWelcome(){
    try{
      const r = await api("/admin/app/welcome/meta");
      if(!r.ok) throw new Error(await r.text());
      const m = await r.json();
      const en = $("#welcomeEnabled"), po = $("#welcomePort");
      if(en) en.checked = !!m.enabled;
      if(po) po.value = m.port;
      setDirectLink(m.port);
      const st=$("#state"); if(st) st.textContent="Ready";
    }catch(e){ const st=$("#state"); if(st) st.textContent="Meta error"; }
  }
  async function saveWelcome(){
    const btn = $("#saveWelcome"); if(btn){btn.disabled=true; btn.textContent="Saving…";}
    const st  = $("#state"); if(st) st.textContent="Updating…";
    const port = parseInt(($("#welcomePort")||{}).value||"0",10);
    const enabled = ($("#welcomeEnabled")||{}).checked;
    if(!(port>=1024 && port<=65535)){
      alert("Invalid port (1024–65535)");
      if(btn){btn.disabled=false; btn.textContent="Save & Restart";}
      if(st) st.textContent="Error";
      return;
    }
    try{
      let r = await api("/admin/app/welcome/port", { method:"POST", body: JSON.stringify({port}) });
      if(!r.ok) throw new Error(await r.text());
      r = await api("/admin/app/welcome/toggle?enabled="+(enabled?"true":"false"), { method:"POST" });
      if(!r.ok) throw new Error(await r.text());
      setDirectLink(port);
      if(st) st.textContent = "Moved to "+port;
    }catch(e){
      alert("Save failed: "+e.message);
      if(st) st.textContent = "Error";
    }finally{
      if(btn){btn.disabled=false; btn.textContent="Save & Restart";}
    }
  }

  window.addEventListener("DOMContentLoaded", function(){
    // Hosting block
    wireHosting();
    status();
    loadSSID();

    // Welcome app block
    const btn = document.getElementById("saveWelcome");
    if(btn && !btn._wired){ btn._wired=true; btn.addEventListener("click", saveWelcome); }
    loadWelcome();
  });
})();
</script>

